#!/bin/bash -e
#
# S2I assemble script for Node.js applications
# This script is responsible for building the application artifacts

echo "---> S2I assemble script starting"
echo "---> Current directory: $(pwd)"

# Copy source files from /tmp/src to current directory
if [ -d /tmp/src ]; then
  echo "---> Copying source files from /tmp/src"
  cp -Rf /tmp/src/. ./
else
  echo "ERROR: /tmp/src directory not found!"
  exit 1
fi

echo "---> Listing files after copy:"
ls -la

echo "---> Installing application dependencies (including dev dependencies for build)"
if [ -f package.json ]; then
  echo "Found package.json"
  if [ -f package-lock.json ]; then
    echo "Found package-lock.json, using npm ci"
    npm ci
  else
    echo "No package-lock.json found, using npm install"
    npm install
  fi
else
  echo "ERROR: package.json not found!"
  exit 1
fi

echo "---> Building application from source"
npm run build

echo "---> Pruning dev dependencies"
npm prune --omit=dev

echo "---> Fixing permissions"
fix-permissions ./